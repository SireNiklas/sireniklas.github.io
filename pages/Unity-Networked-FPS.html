<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Portfolio - Nicholas Harris</title>
        <!-- Favicon-->
        <link rel="icon" type="image/x-icon" href="../assets/favicon.ico" />
        <!-- Font Awesome icons (free version)-->
        <script src="https://use.fontawesome.com/releases/v6.1.0/js/all.js" crossorigin="anonymous"></script>
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css" />
        <link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="../css/styles.css" rel="stylesheet" />

        <style>
            code pre {
            background-color: #161618;
            border: 1px solid #161618;
            display: block;
            padding: 5px;
            }

            a:hover {
                cursor:pointer;
            }
        </style>
    </head>
    <body id="page-top">
        <!-- Navigation-->
        <nav class="navbar navbar-expand-lg bg-secondary text-uppercase fixed-top" id="mainNav">
            <div class="container">
                <a class="navbar-brand" href="#page-top">Nicholas Harris - Game Development</a>
                <button class="navbar-toggler text-uppercase font-weight-bold bg-primary text-white rounded" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    Menu
                    <i class="fas fa-bars"></i>
                </button>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item mx-0 mx-lg-1"><a class="nav-link py-3 px-0 px-lg-3 rounded" href="../index.html#portfolio">Go Back</a></li>
                        <li class="nav-item mx-0 mx-lg-1"><a class="nav-link py-3 px-0 px-lg-3 rounded" data-bs-toggle="modal" data-bs-target="#resumeModal">Resume</a></li>
                    </ul>
                </div>
            </div>
        </nav>
        <!-- Masthead-->
        <header class="masthead bg-primary text-white text-center" id="home">
            <div class="container d-flex align-items-center flex-column">
                    <!-- Portfolio Highlight | Skycadia -->
                    <div class="col-md-6 col-lg-4 mb-5">
                        <div class="portfolio-item mx-auto">
                            <div class="portfolio-item-caption d-flex align-items-center justify-content-center h-100 w-100">
                                <div class="portfolio-item-caption-content text-center text-white"</div>
                            </div>
                            <img class="img-fluid" style="border-radius: 3%; border-style: solid; border-color: #2d3436;" src="../assets/img/portfolio/projectilefight.png" alt="..." />
                        </div>
                    </div>
                </div>
            </p>
            <!--<span style="font-size: 42px">VIEW PROJECTS</span>
            <span style="font-size: 72px">&#129095;</span>-->
            </div>
        </header>
        <!-- Portfolio Section-->
        <section class="page-section portfolio" id="portfolio">
            <div class="container">
                <!-- Portfolio Section Heading-->
                <h2 class="page-section-heading text-center text-white text-uppercase text-secondary mb-0">Unity Networked FPS</h2>
        </section>

<!-- #region Unity Networked FPS -->
        <!-- Portfolio Modal 1 | Projectile Fight-->
                    <div class="text-center pb-5 text-white">
                        <div class="container">
                            <div class="row justify-content-center">
                                <div class="col-lg-8">
                                    <!-- #region Unity Networked FPS Title -->
                                    <!-- Portfolio Modal - Title-->
                                    <!-- TODO TODO TODO | UNITY NETWORKING AND STEAM API -->
                                    <!-- REWORD THIS BELOW -->
                                    <p class="mb-4">Multiplayer FPS Prototype; two clients are able to connect and play via Steam. features include P2P Connection, host to client simulation, and a lobby finder.</p>
                                    <!-- Icon Divider-->
                                    <div class="divider-custom">
                                        <div class="divider-custom-line"></div>
                                        <div class="divider-custom-icon"><i class="fas fa-star"></i></div>
                                        <div class="divider-custom-line"></div>
                                    </div>
                                    <!-- Portfolio Modal - Image-->
                                    <img class="img-fluid rounded mb-5" src="../assets/img/portfolio/multiplayerpfjoineddemo.gif" alt="..." />
                                    <!-- Portfolio Modal - Text-->
                                    <!-- #endregion -->
                                    <!-- #region Unity Networked FPS Features-->
                                    <h6>FEATURES:</h6>
                                    <!-- REWRITE AND ELABERATE | HOW DID I MAKE THIS WORK? -->
                                    <li align="left">Establish a connection between two users simultaneously. (AKA Lobby)</li>
                                    <p align="left">&emsp;&emsp; Each user can create a lobby and another can join that said lobby.</p>
                                    <li align="left">Steam connectivty to allow players to join each other with ease.</li>
                                    <p align="left">&emsp;&emsp; Players can get invites, or join off of their friends to easily connect, and enjoy. (Side note: this also allows for Steams Nat Punchthrough which allows connection without portforwarding.</p>
                                    <li align="left">Server Authoritative for competitive gameplay.</li>
                                    <p align="left">&emsp;&emsp; Keep all players in sync of movement, and allow the server to dictate what goes and what doesn't.</p>
                                    <!-- #endregion -->
                                    <!-- #region Unity Networked FPS Lobby and Connections -->
                                    <hr/><p class="mb-4" align="left">Lobby and client connections were accomplished using Netcode for GameObjects with Facepunch Steamworks. The issues I had were to get the data from the Steam API to interface properly with the Unity objects. <br/><br/> The code snippet below displays how I displayed Lobbies that were created. <br/><br/> I created a filter of <b>isTesting</b> as I was using the test AppID Steam provides. This way I could filter my lobbies out from others. I created a for loop to iterate through each lobby and display each that has that filter attached, thus using Unity's UI ToolKit to display in a list-view each item that it has grabbed, giving the list the data it needs to present.<br/><br/> <sup>Asterisks surrounding words such as <b>Button</b> or <b>Label</b> interfered with the HTML and code presentation</sup></p>
                                    <hr/><code><pre class="mb-4 text-white" align="left">if (SteamManager.Instance.lobbiesList != null)
{

    //Create a list of data. In this case, numbers from 1 to 1000.
    foreach (Lobby lobby in SteamManager.Instance.lobbiesList.ToList())
    {

        SteamManager.Instance.activeLobbies.Add(lobby);
        Debug.Log(SteamManager.Instance.activeLobbies.Count);

    }

    int i = 0;
    
    int itemCount = SteamManager.Instance.activeLobbies.Count;
    var items = new List<Tuple<string, SteamId, int, int>>(itemCount);
    for (i = 0; i < itemCount; i++)
    {
        items.Add(Tuple.Create(SteamManager.Instance.activeLobbies[i].GetData("lobbyName"), SteamManager.Instance.activeLobbies[i].Id, SteamManager.Instance.activeLobbies[i].MemberCount, SteamManager.Instance.activeLobbies[i].MaxMembers));
        Debug.Log(items[i].Item1);
        //Debug.Log(activeLobbies[i]);
    }

    // The "makeItem" function is called when the
    // ListView needs more items to render.
    Func<VisualElement> makeItem = () =>
    {
        var root = new VisualElement();
        var label = new Label();
        root.Add(label);
        return root;
    };

    // As the user scrolls through the list, the ListView object
    // recycles elements created by the "makeItem" function,
    // and invoke the "bindItem" callback to associate
    // the element with the matching data item (specified as an index in the list).
    Action<VisualElement, int> bindItem = (e, i) =>
    {
        var label = e.Q<*Label*>();
        label.text = items[i].Item1 + " | Members: " + items[i].Item3 + "/" + items[i].Item4;
    };

    // Provide the list view with an explict height for every row
    // so it can calculate how many items to actually display
    const int itemHeight = 64;

    var listView = new ListView(items, itemHeight, makeItem, bindItem);

    listView.onItemsChosen += objects => SteamManager.Instance.JoinLobby(items[listView.selectedIndex].Item2);
    //SteamManager.Instance.currLobby = items[listView.selectedIndex].Item2;
    //listView.onSelectionChange += objects => Debug.Log(items[listView.selectedIndex].ToString());

    // List Style
    listView.showAlternatingRowBackgrounds = AlternatingRowBackground.All;
    listView.selectionType = SelectionType.Single;
    listView.style.flexGrow = 1.0f;
    listView.style.fontSize = 48f;
    listView.style.justifyContent = Justify.Center;
    listView.showBoundCollectionSize = true;

    body.Add(listView);
}                                   
                                    </pre></code>
                                    <br/><br/><hr/>
                                    <p class="mb-4 text-white" align="left">Server Prediction and Client Reconciliation were my two primary problems that I had to solve. <br/><br/>The code below checks if the player is not equal to the server position then the server will correct the player by setting the client's transform to that of the server's transform.</p>
                                    <hr/><code><pre class="mb-4 text-white" align="left">void OnServerStateChanged(TransformState previousState, TransformState serverState) {
if (!IsLocalPlayer) return;

if (_previousTransformState == null) {
    _previousTransformState = serverState;
}

TransformState calculatedState = _transformStates.First(localState => localState.Tick == serverState.Tick);

if (calculatedState.Position != serverState.Position) {
    Debug.Log("CORRECTING CLIENT POS!");
        
    //Teleport the player to server pos.
    TeleportPlayer(serverState);

    //Replay the inputs that happened after. | Change to for loop if needed. (Not optimised as is.
    IEnumerable<InputState> inputs = _inputStates.Where(input => input.Tick > serverState.Tick);

    // Lazy way of sorting, algorithm would be better.
    inputs = from input in inputs orderby input.Tick select input;

        foreach (InputState inputState in inputs) {
            MovePlayer(inputState.movementInput);
            RotatePlayer(inputState.lookInput);

            TransformState newTranformState = new TransformState()
            {
                Tick = inputState.Tick,
                Position = transform.position,
                Rotation = transform.rotation,
                HasStartedMoving = true

            };

            // Could be written better once I understand how to write it better.
            for (int i = 0; i < _transformStates.Length; i++)
            {
                if (_transformStates[i].Tick == inputState.Tick)
                {
                    _transformStates[i] = newTranformState;
                    break;
                }
            }
        }
    }
}

private void TeleportPlayer(TransformState state)
{
    _controller.enabled = false;
    transform.position = state.Position;
    transform.rotation = state.Rotation;
    _controller.enabled = true;

    for (int i = 0; i < _transformStates.Length; i++)
    {
        if (_transformStates[i].Tick == state.Tick)
        {
            _transformStates[i] = state;
            break;
        }
    }
}
                                    </pre></code>
                                    <!-- #endregion -->
                                    <!-- #region Unity Networked FPS Buttons -->
                                    <a href="../index.html#portfolio"><button class="btn btn-primary">
                                        <i class="fas fa-xmark fa-fw"></i>
                                        Go Back
                                    </button></a>
                                    &nbsp;&nbsp;<button class="btn btn-primary" onclick="window.open('https://github.com/SireNiklas/Projectile-Fight/tree/Server-Authority-Migration','_blank')">
                                        <i class="fab fa-fw fa-github"></i>
                                        Visit <b>Unity Networked FPS</b> Github page.
                                    </button>
                                    <!-- #endregion -->
                                </div>
                            </div>
                        </div>
        <!-- Copyright Section-->
        <div class="copyright py-4 text-center text-white">
            <div class="container"><small>&copy; 2023 sireniklas.github.io</small></div>
        </div>

                <!-- Portfolio Modal - PORTFOLIO -->
        <div class="portfolio-modal modal fade" id="resumeModal" tabindex="-1" aria-labelledby="resumeModal" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header border-0"><button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button></div>
                    <div class="modal-body text-center pb-5">
                        <div class="container">
                            <div class="row justify-content-center">
                                <div class="col-lg-8">
                                    <!-- Portfolio Modal - Title-->
                                    <h2 class="portfolio-modal-title text-white text-uppercase mb-0">NICHOLAS HARRIS - RESUME</h2>
                                    <!-- Icon Divider-->
                                    <div class="divider-custom">
                                        <div class="divider-custom-line"></div>
                                        <div class="divider-custom-icon"><i class="fas fa-star"></i></div>
                                        <div class="divider-custom-line"></div>
                                    </div>
                                    <!-- Portfolio Modal - Image-->
                                    <div class="modal-body">

                                        <embed src="../assets/resume\Nicholas Harris Resume.pdf#toolbar=0&navpanes=0&scrollbar=0"
                                               frameborder="0" width="100%" height="700">
                                    <!-- Portfolio Modal - Text-->
                                    <button class="btn btn-primary" data-bs-dismiss="modal">
                                        <i class="fas fa-xmark fa-fw"></i>
                                        Close Window
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
        $(document).ready(function() {

          if(window.location.href.indexOf('#portfolioModal3') != -1) {
            $('#portfolioModal3').modal('show');
          }

        });
        </script>

        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>
        <!-- * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *-->
        <!-- * *                               SB Forms JS                               * *-->
        <!-- * * Activate your form at https://startbootstrap.com/solution/contact-forms * *-->
        <!-- * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *-->
        <script src="https://cdn.startbootstrap.com/sb-forms-latest.js"></script>
    </body>
</html>
